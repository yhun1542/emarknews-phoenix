#!/usr/bin/env node

const axios = require('axios');
const fs = require('fs');
const path = require('path');

// ÏÉâÏÉÅ ÏΩîÎìú
const colors = {
    reset: '\x1b[0m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
    white: '\x1b[37m'
};

// Ïù¥Î™®ÏßÄ
const emoji = {
    check: '‚úÖ',
    cross: '‚ùå',
    warning: '‚ö†Ô∏è',
    rocket: 'üöÄ',
    gear: '‚öôÔ∏è',
    news: 'üì∞',
    currency: 'üí±',
    youtube: 'üì∫',
    api: 'üîó',
    server: 'üñ•Ô∏è',
    database: 'üóÑÔ∏è'
};

class EmarkNewsDiagnostic {
    constructor() {
        this.baseUrl = 'https://emarknews.com';
        this.results = [];
        this.startTime = Date.now();
    }

    log(message, color = 'white', symbol = '') {
        const colorCode = colors[color] || colors.white;
        console.log(`${colorCode}${symbol} ${message}${colors.reset}`);
    }

    logSuccess(message) {
        this.log(message, 'green', emoji.check);
    }

    logError(message) {
        this.log(message, 'red', emoji.cross);
    }

    logWarning(message) {
        this.log(message, 'yellow', emoji.warning);
    }

    logInfo(message) {
        this.log(message, 'cyan', emoji.gear);
    }

    addResult(test, status, details = '', responseTime = null) {
        this.results.push({
            test,
            status,
            details,
            responseTime,
            timestamp: new Date().toISOString()
        });
    }

    async measureResponseTime(asyncFunction) {
        const start = Date.now();
        try {
            const result = await asyncFunction();
            const responseTime = Date.now() - start;
            return { result, responseTime, success: true };
        } catch (error) {
            const responseTime = Date.now() - start;
            return { error, responseTime, success: false };
        }
    }

    async testBasicConnectivity() {
        this.log('\n=== Í∏∞Î≥∏ Ïó∞Í≤∞ÏÑ± ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/`, { timeout: 10000 });
        });

        if (success) {
            this.logSuccess(`ÏõπÏÇ¨Ïù¥Ìä∏ Ï†ëÍ∑º Í∞ÄÎä• (${responseTime}ms)`);
            this.addResult('Basic Connectivity', 'PASS', `Status: ${result.status}`, responseTime);
        } else {
            this.logError(`ÏõπÏÇ¨Ïù¥Ìä∏ Ï†ëÍ∑º Ïã§Ìå®: ${error.message}`);
            this.addResult('Basic Connectivity', 'FAIL', error.message, responseTime);
        }
        
        return success;
    }

    async testHealthEndpoint() {
        this.log('\n=== Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏóîÎìúÌè¨Ïù∏Ìä∏ ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/health`, { timeout: 10000 });
        });

        if (success) {
            this.logSuccess(`Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ (${responseTime}ms)`);
            this.logInfo(`ÏÑúÎ≤Ñ ÏÉÅÌÉú: ${JSON.stringify(result.data, null, 2)}`);
            this.addResult('Health Check', 'PASS', JSON.stringify(result.data), responseTime);
            return result.data;
        } else {
            this.logError(`Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®: ${error.message}`);
            this.addResult('Health Check', 'FAIL', error.message, responseTime);
            return null;
        }
    }

    async testNewsAPI() {
        this.log('\n=== Îâ¥Ïä§ API ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const sections = ['world', 'kr', 'japan', 'tech', 'business', 'buzz'];
        let successCount = 0;
        
        for (const section of sections) {
            const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
                return await axios.get(`${this.baseUrl}/api/news/${section}`, { timeout: 15000 });
            });

            if (success) {
                const articleCount = result.data?.data?.articles?.length || 0;
                if (articleCount > 0) {
                    this.logSuccess(`${section.toUpperCase()}: ${articleCount}Í∞ú Í∏∞ÏÇ¨ (${responseTime}ms)`);
                    successCount++;
                } else {
                    this.logWarning(`${section.toUpperCase()}: Í∏∞ÏÇ¨ ÏóÜÏùå (${responseTime}ms)`);
                    this.logInfo(`ÏùëÎãµ Îç∞Ïù¥ÌÑ∞: ${JSON.stringify(result.data, null, 2)}`);
                }
                this.addResult(`News API - ${section}`, articleCount > 0 ? 'PASS' : 'EMPTY', 
                    `Articles: ${articleCount}`, responseTime);
            } else {
                this.logError(`${section.toUpperCase()}: API Ïò§Î•ò - ${error.message}`);
                this.addResult(`News API - ${section}`, 'FAIL', error.message, responseTime);
            }
        }
        
        this.logInfo(`Îâ¥Ïä§ API ÏÑ±Í≥µÎ•†: ${successCount}/${sections.length}`);
        return successCount;
    }

    async testCurrencyAPI() {
        this.log('\n=== ÌôòÏú® API ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/api/currency`, { timeout: 10000 });
        });

        if (success) {
            const hasRates = result.data?.data?.rates ? Object.keys(result.data.data.rates).length : 0;
            if (hasRates > 0) {
                this.logSuccess(`ÌôòÏú® Ï†ïÎ≥¥ ${hasRates}Í∞ú ÌÜµÌôî (${responseTime}ms)`);
                this.addResult('Currency API', 'PASS', `Currencies: ${hasRates}`, responseTime);
            } else {
                this.logWarning(`ÌôòÏú® Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå (${responseTime}ms)`);
                this.addResult('Currency API', 'EMPTY', 'No currency data', responseTime);
            }
        } else {
            this.logError(`ÌôòÏú® API Ïã§Ìå®: ${error.message}`);
            this.addResult('Currency API', 'FAIL', error.message, responseTime);
        }
        
        return success;
    }

    async testYouTubeAPI() {
        this.log('\n=== Ïú†ÌäúÎ∏å API ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/api/youtube/world`, { timeout: 10000 });
        });

        if (success) {
            const videoCount = result.data?.data?.videos?.length || 0;
            if (videoCount > 0) {
                this.logSuccess(`Ïú†ÌäúÎ∏å ÎπÑÎîîÏò§ ${videoCount}Í∞ú (${responseTime}ms)`);
                this.addResult('YouTube API', 'PASS', `Videos: ${videoCount}`, responseTime);
            } else {
                this.logWarning(`Ïú†ÌäúÎ∏å Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå (${responseTime}ms)`);
                this.addResult('YouTube API', 'EMPTY', 'No video data', responseTime);
            }
        } else {
            this.logError(`Ïú†ÌäúÎ∏å API Ïã§Ìå®: ${error.message}`);
            this.addResult('YouTube API', 'FAIL', error.message, responseTime);
        }
        
        return success;
    }

    async testRSSFeeds() {
        this.log('\n=== RSS ÌîºÎìú ÏßÅÏ†ë ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const rssFeeds = [
            { name: 'BBC World', url: 'https://feeds.bbci.co.uk/news/world/rss.xml' },
            { name: 'Reuters', url: 'https://www.reutersagency.com/feed/?best-topics=business-finance&post_type=best' },
            { name: 'Ïó∞Ìï©Îâ¥Ïä§', url: 'https://www.yna.co.kr/rss/news.xml' },
            { name: 'TechCrunch', url: 'https://techcrunch.com/feed/' }
        ];

        let successCount = 0;

        for (const feed of rssFeeds) {
            const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
                return await axios.get(feed.url, { 
                    timeout: 10000,
                    headers: {
                        'User-Agent': 'EmarkNews/7.0 (Diagnostic Tool)'
                    }
                });
            });

            if (success) {
                this.logSuccess(`${feed.name}: Ï†ëÍ∑º Í∞ÄÎä• (${responseTime}ms)`);
                successCount++;
                this.addResult(`RSS Feed - ${feed.name}`, 'PASS', `Size: ${result.data.length} bytes`, responseTime);
            } else {
                this.logError(`${feed.name}: Ï†ëÍ∑º Ïã§Ìå® - ${error.message}`);
                this.addResult(`RSS Feed - ${feed.name}`, 'FAIL', error.message, responseTime);
            }
        }

        this.logInfo(`RSS ÌîºÎìú ÏÑ±Í≥µÎ•†: ${successCount}/${rssFeeds.length}`);
        return successCount;
    }

    async testExternalAPIs() {
        this.log('\n=== Ïô∏Î∂Ä API ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const externalAPIs = [
            { 
                name: 'OpenAI API', 
                test: async () => {
                    if (!process.env.OPENAI_API_KEY) {
                        throw new Error('OPENAI_API_KEY not configured');
                    }
                    return { configured: true };
                }
            },
            {
                name: 'Exchange Rate API',
                test: async () => {
                    const response = await axios.get('https://api.exchangerate-api.com/v4/latest/USD', { timeout: 5000 });
                    return response.data;
                }
            }
        ];

        for (const api of externalAPIs) {
            const { result, error, responseTime, success } = await this.measureResponseTime(api.test);
            
            if (success) {
                this.logSuccess(`${api.name}: Ï†ïÏÉÅ (${responseTime}ms)`);
                this.addResult(`External API - ${api.name}`, 'PASS', '', responseTime);
            } else {
                this.logWarning(`${api.name}: ${error.message}`);
                this.addResult(`External API - ${api.name}`, 'FAIL', error.message, responseTime);
            }
        }
    }

    async testDatabaseConnection() {
        this.log('\n=== Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        // Health ÏóîÎìúÌè¨Ïù∏Ìä∏ÏóêÏÑú Redis ÏÉÅÌÉú ÌôïÏù∏
        const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/health`, { timeout: 5000 });
        });

        if (success && result.data.redis) {
            const redisStatus = result.data.redis.status;
            if (redisStatus === 'connected') {
                this.logSuccess(`Redis: Ïó∞Í≤∞Îê® (${responseTime}ms)`);
                this.addResult('Database - Redis', 'PASS', 'Connected', responseTime);
            } else {
                this.logWarning(`Redis: ${redisStatus}`);
                this.addResult('Database - Redis', 'WARNING', redisStatus, responseTime);
            }
        } else {
            this.logError('Redis: ÏÉÅÌÉú ÌôïÏù∏ Î∂àÍ∞Ä');
            this.addResult('Database - Redis', 'FAIL', 'Status check failed', responseTime);
        }
    }

    async testFrontendResources() {
        this.log('\n=== ÌîÑÎ°†Ìä∏ÏóîÎìú Î¶¨ÏÜåÏä§ ÌÖåÏä§Ìä∏ ===', 'magenta');
        
        const resources = [
            '/',
            '/favicon.ico'
        ];

        for (const resource of resources) {
            const { result, error, responseTime, success } = await this.measureResponseTime(async () => {
                return await axios.get(`${this.baseUrl}${resource}`, { timeout: 5000 });
            });

            if (success) {
                this.logSuccess(`${resource}: Î°úÎìú ÏÑ±Í≥µ (${responseTime}ms, ${result.data.length} bytes)`);
                this.addResult(`Frontend - ${resource}`, 'PASS', `Size: ${result.data.length}`, responseTime);
            } else {
                this.logError(`${resource}: Î°úÎìú Ïã§Ìå® - ${error.message}`);
                this.addResult(`Frontend - ${resource}`, 'FAIL', error.message, responseTime);
            }
        }
    }

    async performAdvancedDiagnostics() {
        this.log('\n=== Í≥†Í∏â ÏßÑÎã® ===', 'magenta');
        
        // 1. Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ Ï≤¥ÌÅ¨ (Ìó¨Ïä§ ÏóîÎìúÌè¨Ïù∏Ìä∏ÏóêÏÑú)
        const { result } = await this.measureResponseTime(async () => {
            return await axios.get(`${this.baseUrl}/health`);
        });

        if (result?.data?.memory) {
            const memory = result.data.memory;
            const memoryUsageMB = Math.round(memory.heapUsed / 1024 / 1024);
            const memoryLimitMB = Math.round(memory.heapTotal / 1024 / 1024);
            
            this.logInfo(`Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ: ${memoryUsageMB}MB / ${memoryLimitMB}MB`);
            
            if (memoryUsageMB / memoryLimitMB > 0.9) {
                this.logWarning('Î©îÎ™®Î¶¨ ÏÇ¨Ïö©ÎüâÏù¥ ÎÜíÏäµÎãàÎã§');
            }
        }

        // 2. ÏùëÎãµ ÏãúÍ∞Ñ Î∂ÑÏÑù
        const avgResponseTime = this.results
            .filter(r => r.responseTime !== null)
            .reduce((sum, r) => sum + r.responseTime, 0) / 
            this.results.filter(r => r.responseTime !== null).length;
            
        this.logInfo(`ÌèâÍ∑† ÏùëÎãµ ÏãúÍ∞Ñ: ${Math.round(avgResponseTime)}ms`);
        
        if (avgResponseTime > 5000) {
            this.logWarning('ÏùëÎãµ ÏãúÍ∞ÑÏù¥ ÎäêÎ¶ΩÎãàÎã§ (5Ï¥à Ïù¥ÏÉÅ)');
        }
    }

    generateReport() {
        this.log('\n=== ÏßÑÎã® Í≤∞Í≥º Î¶¨Ìè¨Ìä∏ ===', 'magenta');
        
        const totalTests = this.results.length;
        const passedTests = this.results.filter(r => r.status === 'PASS').length;
        const failedTests = this.results.filter(r => r.status === 'FAIL').length;
        const warningTests = this.results.filter(r => r.status === 'WARNING' || r.status === 'EMPTY').length;

        this.log(`\nÏ¥ù ÌÖåÏä§Ìä∏: ${totalTests}`, 'white');
        this.logSuccess(`ÌÜµÍ≥º: ${passedTests}`);
        this.logError(`Ïã§Ìå®: ${failedTests}`);
        this.logWarning(`Í≤ΩÍ≥†: ${warningTests}`);

        const totalTime = Date.now() - this.startTime;
        this.log(`\nÏ¥ù ÏÜåÏöî ÏãúÍ∞Ñ: ${totalTime}ms`, 'cyan');

        // Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏Îì§ ÏöîÏïΩ
        const failedDetails = this.results.filter(r => r.status === 'FAIL');
        if (failedDetails.length > 0) {
            this.log('\nüö® Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏Îì§:', 'red');
            failedDetails.forEach(test => {
                this.log(`  ‚Ä¢ ${test.test}: ${test.details}`, 'red');
            });
        }

        // Í≤ΩÍ≥† ÌÖåÏä§Ìä∏Îì§ ÏöîÏïΩ
        const warningDetails = this.results.filter(r => r.status === 'WARNING' || r.status === 'EMPTY');
        if (warningDetails.length > 0) {
            this.log('\n‚ö†Ô∏è Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌïú Ìï≠Î™©Îì§:', 'yellow');
            warningDetails.forEach(test => {
                this.log(`  ‚Ä¢ ${test.test}: ${test.details}`, 'yellow');
            });
        }

        // Í∂åÏû• Ìï¥Í≤∞Ï±Ö
        this.generateRecommendations();

        // ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏ ÌååÏùº Ï†ÄÏû•
        this.saveDetailedReport();
    }

    generateRecommendations() {
        this.log('\n=== Í∂åÏû• Ìï¥Í≤∞Ï±Ö ===', 'magenta');
        
        const newsAPIFailed = this.results.some(r => r.test.includes('News API') && r.status === 'FAIL');
        const newsAPIEmpty = this.results.some(r => r.test.includes('News API') && r.status === 'EMPTY');
        const rssFailures = this.results.filter(r => r.test.includes('RSS Feed') && r.status === 'FAIL').length;
        
        if (newsAPIFailed) {
            this.log('üì∞ Îâ¥Ïä§ API Î¨∏Ï†ú Ìï¥Í≤∞Ï±Ö:', 'yellow');
            this.log('  1. Railway Î°úÍ∑∏ ÌôïÏù∏: railway logs', 'white');
            this.log('  2. ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë: railway restart', 'white');
            this.log('  3. ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏', 'white');
        }

        if (newsAPIEmpty) {
            this.log('üì∞ Îâ¥Ïä§ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå Ìï¥Í≤∞Ï±Ö:', 'yellow');
            this.log('  1. RSS ÌîºÎìú URL ÌôïÏù∏', 'white');
            this.log('  2. Ïô∏Î∂Ä API ÌÇ§ ÏÑ§Ï†ï ÌôïÏù∏', 'white');
            this.log('  3. ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞©ÌôîÎ≤Ω ÌôïÏù∏', 'white');
        }

        if (rssFailures > 2) {
            this.log('üåê RSS ÌîºÎìú Î¨∏Ï†ú Ìï¥Í≤∞Ï±Ö:', 'yellow');
            this.log('  1. ÏÑúÎ≤ÑÏùò Ïô∏Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ëÍ∑º ÌôïÏù∏', 'white');
            this.log('  2. User-Agent Ìó§Îçî ÏÑ§Ï†ï ÌôïÏù∏', 'white');
            this.log('  3. ÎåÄÏ≤¥ RSS ÌîºÎìú URL ÏÇ¨Ïö©', 'white');
        }

        const redisIssue = this.results.some(r => r.test.includes('Redis') && r.status !== 'PASS');
        if (redisIssue) {
            this.log('üóÑÔ∏è Redis Î¨∏Ï†ú Ìï¥Í≤∞Ï±Ö:', 'yellow');
            this.log('  1. RailwayÏóêÏÑú Redis ÏÑúÎπÑÏä§ Ï∂îÍ∞Ä', 'white');
            this.log('  2. REDIS_URL ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï', 'white');
            this.log('  3. Redis ÏóÜÏù¥ÎèÑ ÏûëÎèôÌïòÎèÑÎ°ù ÏΩîÎìú ÌôïÏù∏', 'white');
        }
    }

    saveDetailedReport() {
        const reportData = {
            timestamp: new Date().toISOString(),
            url: this.baseUrl,
            summary: {
                total: this.results.length,
                passed: this.results.filter(r => r.status === 'PASS').length,
                failed: this.results.filter(r => r.status === 'FAIL').length,
                warnings: this.results.filter(r => r.status === 'WARNING' || r.status === 'EMPTY').length
            },
            tests: this.results,
            duration: Date.now() - this.startTime
        };

        const reportPath = path.join(process.cwd(), `emarknews-diagnostic-${Date.now()}.json`);
        
        try {
            fs.writeFileSync(reportPath, JSON.stringify(reportData, null, 2));
            this.logInfo(`ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏ Ï†ÄÏû•Îê®: ${reportPath}`);
        } catch (error) {
            this.logWarning(`Î¶¨Ìè¨Ìä∏ Ï†ÄÏû• Ïã§Ìå®: ${error.message}`);
        }
    }

    async runFullDiagnostic() {
        this.log('üöÄ EmarkNews ÏãúÏä§ÌÖú ÏßÑÎã® ÏãúÏûë', 'cyan');
        this.log(`ÎåÄÏÉÅ URL: ${this.baseUrl}`, 'cyan');
        this.log(`ÏãúÏûë ÏãúÍ∞Ñ: ${new Date().toLocaleString()}`, 'cyan');

        try {
            // Í∏∞Î≥∏ Ïó∞Í≤∞ÏÑ± ÌÖåÏä§Ìä∏
            const basicOK = await this.testBasicConnectivity();
            if (!basicOK) {
                this.logError('Í∏∞Î≥∏ Ïó∞Í≤∞ Ïã§Ìå®. ÏÑúÎ≤ÑÍ∞Ä Îã§Ïö¥ÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }

            // Ìó¨Ïä§Ï≤¥ÌÅ¨
            await this.testHealthEndpoint();

            // API ÌÖåÏä§Ìä∏Îì§
            await this.testNewsAPI();
            await this.testCurrencyAPI();
            await this.testYouTubeAPI();

            // Ïô∏Î∂Ä Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            await this.testRSSFeeds();
            await this.testExternalAPIs();

            // Ïù∏ÌîÑÎùº ÌÖåÏä§Ìä∏
            await this.testDatabaseConnection();
            await this.testFrontendResources();

            // Í≥†Í∏â ÏßÑÎã®
            await this.performAdvancedDiagnostics();

            // Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
            this.generateReport();

        } catch (error) {
            this.logError(`ÏßÑÎã® Ï§ë ÏπòÎ™ÖÏ†Å Ïò§Î•ò: ${error.message}`);
        }
    }
}

// Î©îÏù∏ Ïã§Ìñâ
async function main() {
    const diagnostic = new EmarkNewsDiagnostic();
    await diagnostic.runFullDiagnostic();
}

// CLIÏóêÏÑú Ïã§ÌñâÎêú Í≤ΩÏö∞
if (require.main === module) {
    main().catch(console.error);
}

module.exports = EmarkNewsDiagnostic;